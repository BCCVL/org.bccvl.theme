<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      tal:define="pc nocall:context/portal_catalog"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="org.bccvl.site">
<body>
    <!--<metal:slot metal:fill-slot="header" i18n:domain="cmf_default">-->
      <!--<h1 tal:content="view/label">View Title</h1>-->
    <!--</metal:slot>-->
    <metal:main fill-slot="main">

      <ul class="nav nav-tabs">
      	<li id= "tab-res"><a href="view#tab-results">Results</a></li>
        <li id= "tab-det"><a href="view#tab-details">Details</a></li>
        <li id= "tab-overlay" class="active"><a href="experiment_overlay#tab-overlay">Overlay</a></li>
        <li id= "tab-comp"><a href="experiment_compare#tab-comp">Compare</a></li>
      </ul>


        <h1 class="documentFirstHeading" tal:content="context/title">Title</h1>

        <div id="bccvl-experiment-overlay">
            <div id="bccvl-experimentresults-table" >
              <h5 class="results-title">Experiment Inputs</h5>
              <div class="bccvl-experimenttable-accordion accordion-group">
                <!-- occurrence/absence dataset -->
                <tal:block tal:repeat="uuid python:(context.species_occurrence_dataset, context.species_absence_dataset)"
                           tal:condition="python: context.portal_type=='org.bccvl.content.sdmexperiment'">
                  <div class="row-fluid experiment-result-contents"
                       tal:define="result python:pc.searchResults(UID=uuid);
                                  item python: result[0] if result else nothing;
                                  item_obj item/getObject|nothing;
                                  dataset_tools nocall:item_obj/dataset_tools|nothing"
                       tal:condition="uuid">
                    <div class="span9 bccvl-table-label"
                        tal:define="md dataset_tools/metadata">
                      <h5 tal:content="item/Title">Item Title</h5>
                      <p><span tal:condition="item/Description"
                        tal:content="item/Description">Dataset short description</span>
                      <span tal:condition="md/rows|nothing">Rows: <i tal:content="md/rows"></i></span>
                      <span tal:condition="md/species/scientificName|nothing">Species: <i tal:content="md/species/scientificName"></i></span></p>
                    </div>
                    <div class="bccvl-table-controls span3"
                        tal:define="dlinfo dataset_tools/get_download_info;
                                    downloadurl dlinfo/url;
                                    visurl python: dlinfo['alturl'][0]">
                      <a class="bccvl-compare-viz btn btn-primary"
                         title="Preview this file"
                         data-viz-id="#downloadurl"
                         data-viz-type="occurrence"
                         data-mimetype="application/octet-tream"
                         data-uuid="a uuid"
                         tal:attributes="data-viz-id visurl;
                                         data-file-url downloadurl;
                                         data-uuid item/UID;
                                         data-mimetype item/Format;
                                         data-layername item/Title;"
                         tal:condition="python: item_obj.file and item_obj.file.contentType not
                                        in (None, 'None', 'application/octet-stream', 'application/zip','application/x-r-data', 'txt/html', 'text/html')">
                        <i class="icon-eye-open icon-link icon-white"></i>
                      </a>
                    </div>
                  </div>
                </tal:block>
                <!-- TODO: add climate and enviro layers -->

              </div>

              <h5 class="results-title">Visualisable Experiment Results</h5>
              <tal:block tal:repeat="result context/@@folderListing">
                <div class="bccvl-experimenttable-accordion accordion-group">
                  <div class="experiment-accordion-heading" data-toggle="collapse" data-target="#demo" data-parent="#bccvl-experimentresults-table"
                      tal:attributes="data-target string:#${result/getId}-body">
                      <div tal:attributes="class result/@@dataset_tools/job_state|string:info;">
                      <div class="bccvl-table-controls">
                        <a class="fine btn btn-mini btn-info download-btn"
                             title="Download this result"
                             href="#downloadurl"
                             tal:attributes="href string:${result/getURL}/@@resultdownload;">
                            <i class="fa fa-download icon-link"></i> Download
                          </a>
                        <a class="fine btn btn-mini btn-default expand-btn"
                             title="Expand results"
                             href="javascript:void(0)"
                             data-toggle="collapse" 
                             tal:attributes="data-target string:#${result/getId}-body">
                            <i class="fa fa-chevron-circle-down icon-link"></i> More
                          </a>
                      </div>
                      <div class="experiment-details">
                      <h5><tal:replace tal:replace="result/Title">Result
                      Title</tal:replace></h5>
                      <!-- FIXME: get a better condition or use
                           adapters -->
                      <tal:block tal:condition="python: 'function' in result.job_params">
                        <p><span>Algorithm: <tal:replace tal:replace="result/job_params/function">bioclim</tal:replace></span>
                        <span>State: <tal:replace tal:replace="result/@@dataset_tools/job_state"></tal:replace></span></p>
                      </tal:block>
                      <tal:block tal:condition="python: 'future_climate_datasets' in result.job_params">
                        <p><span>Emissions Scenario: <tal:replace
                                       tal:replace="result/job_params/emsc">bioclim</tal:replace></span>
                        <span>Circulation Model: <tal:replace
                                       tal:replace="result/job_params/gcm">bioclim</tal:replace></span>
                        <span>Year: <tal:replace
                                  tal:replace="result/job_params/year">bioclim</tal:replace></span>
                        <span>State: <tal:replace tal:replace="result/@@dataset_tools/job_state"></tal:replace></span></p>
                      </tal:block>
                    </div>
                  </div>
                </div>
                <div class="collapse" tal:attributes="id string:${result/getId}-body">
                  <tal:block tal:repeat="item python:result.getObject().restrictedTraverse('@@folderListing')(Title='tif');">
                     <div class="row-fluid experiment-result-contents">
                       <div class="span9 bccvl-table-label"
                           tal:define="itemobj item/getObject;
                                       md itemobj/dataset_tools/metadata">
                         <h5><span tal:content="item/Title">Item Title</span></h5>
                         <p><span tal:content="item/Description">Dataset short description</span>
                         <span tal:condition="md/rows|nothing">Rows: <i tal:content="md/rows"></i></span>
                         <span tal:condition="md/species/scientificname|nothing">Species: <i tal:content="md/scientificname"></i></span>
                         <!-- <p tal:condition="md/width">size:<i tal:content="md/width"></i>x<i tal:content="md/height"></i></p> -->
                         <!-- <p tal:condition="md/min">min/max:<i tal:content="md/min"></i>/<i tal:content="md/max"></i></p> -->
                         <span tal:condition="md/resolution|nothing">Resolution: <i tal:content="md/resolution"></i></span></p>
                         <!-- <p tal:condition="md/crs">crs:<i tal:content="md/crs"></i></p> -->

                       </div>
                       <div class="bccvl-table-controls span3"
                           tal:define="item_obj item/getObject;
                                       dlinfo item_obj/dataset_tools/get_download_info;
                                       downloadurl dlinfo/url;
                                       visurl python: dlinfo['alturl'][0]">

                         <a class="fine btn btn-info"
                            title="Download this file"
                            href="#downloadurl"
                            tal:attributes="href downloadurl;
                                            data-friendlyname string:a_experimentoutput_${item/file/filename}">
                            <i class="icon-download-alt icon-link icon-white"></i>
                         </a>
                         <a class="bccvl-compare-viz btn btn-primary"
                            title="Preview this file"
                            data-viz-id="#downloadurl"
                            data-viz-type="auto"
                            data-mimetype="application/octet-tream"
                            data-uuid="a uuid"
                            tal:attributes="data-viz-id visurl;
                                            data-file-url downloadurl;
                                            data-uuid item/UID;
                                            data-mimetype item/Format;
                                            data-layername item/Title"
                            tal:condition="python: item.Format() not
                                           in (None, 'None', 'application/octet-stream', 'application/zip','application/x-r-data', 'txt/html', 'text/html')">
                            <i class="icon-eye-open icon-link icon-white"></i>
                         </a>

                       </div>
                     </div>
                  </tal:block>
                  </div>
                </div>
                </tal:block>
              
            
        </div>
    </metal:main>

</body>
</html>
