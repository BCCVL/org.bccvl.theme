<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="plone.z3cform"
      tal:define="plone_view context/@@plone;
                  normalizeString nocall: context/plone_utils/normalizeString;
                  toLocalizedTime nocall: context/@@plone/toLocalizedTime;
                  site_properties context/portal_properties/site_properties;
                  use_view_action site_properties/typesUseViewActionInListings|python:();
                  pas_member context/@@pas_member;
                  isAnon context/@@plone_portal_state/anonymous;
                  show_about python:not isAnon or site_properties.allowAnonymousViewAbout;
                  dummy python:request.response.setHeader('X-Theme-Disabled', 'True');

                  dataset_tools nocall:context/@@dataset_tools;

                  navigation_root_url context/@@plone_portal_state/navigation_root_url;

                  filters python:request.get('datasets.filters', ());
                  multiple python:request.get('datasets.multiple', '');
                  "
      tal:omit-tag="">

  <div class="row-fluid">
    <div class="span3">
      <form id="datasets-popup-searchform" action="" method="GET" class="span12"
          tal:define="context_state context/@@plone_context_state"
          tal:attributes="action context_state/current_base_url">
        <input type="hidden" name="datasets.filters:list" value=""
               tal:attributes="value val"
               tal:repeat="val filters"/>
        <input type="hidden" name="datasets.multiple" value=""
               tal:attributes="value multiple"/>
        <div class="popup-filter" tal:condition="python: 'resolution' in filters">
            <label for="datasets-filter-resolution">Choose a Resolution to Begin</label>
            <select id="datasets-filter-resolution"
                    name="datasets.filter.resolution:list"
                    multiple="multiple">
              <option disabled="disabled" value="">Type to search, or scroll to browse...</option>
              <option value="resolutionid"
                      tal:repeat="opt dataset_tools/resolution_list"
                      tal:attributes="selected opt/selected;
                                      disabled opt/disabled;
                                      value opt/token;"
                      tal:content="opt/label">Resolution title</option>
            </select>
        </div>
        <div class="popup-filter" tal:condition="python: 'text' in filters">
          <label for="datasets-filter-text">Filter by Keywords</label>
          <input id="datasets-filter-text"
                 name="datasets.filter.text" type="text"
                 placeholder="Enter search terms." class="input-medium"
                 tal:attributes="value python:request.get('datasets.filter.text')"/>
          <input name="datasets.filter.genre:list" type="hidden"
                 tal:attributes="value genre"
                 tal:repeat="genre python:request.get('datasets.filter.genre')"/>

        </div>
        <div class="popup-filter" tal:condition="python: 'source' in filters">
          <label for="datasets-filter-source">Filter by Source</label>
          <select id="datasets-filter-source"
                  name="datasets.filter.source:list"
                  multiple="multiple" placeholder="Type to search, or scroll to browse..." class="selectize group">
            <optgroup tal:repeat="group dataset_tools/source_list"
                      tal:attributes="label group/label">
              <option option="optionvalue"
                      tal:repeat="opt python:group['items']"
                      tal:attributes="selected opt/selected;
                                      disabled opt/disabled;
                                      value opt/token;
                                      id string:selectbox-$opt/token};"
                      tal:content="opt/label">Option label</option>
            </optgroup>
          </select>
        </div>
        <div class="popup-filter" tal:condition="python: 'layer' in filters">
          <label for="datasets-filter-layer">Filter by Layers</label>
          <select id="datasets-filter-layer"
                  name="datasets.filter.layer:list"
                  multiple="multiple">
            <option disabled="disabled" value="">Type to search, or scroll to browse...</option>
            <option value="layerid"
                    tal:repeat="opt dataset_tools/layer_list"
                    tal:attributes="selected opt/selected;
                                    disabled opt/disabled;
                                    value opt/token;"
                    tal:content="opt/label">Layer title</option>
          </select>
        </div>
        <div class="popup-filter">
          <label for="datasets-filter-source">Apply Filters</label>
          <button class="btn btn-block" type="submit">Search!</button>
          <p tal:condition="python: 'layer' in filters"><small>Select multiple layers by <strong>clicking checkboxes</strong> when clicking on results.</small></p>
          <p tal:condition="python: 'layer' not in filters"><small>Only <strong>one dataset</strong> can be selected here.</small></p>
        </div>
      </form>
    </div>
    <div id="datasets-popup-result" class="span9"
         tal:define="batch view/datasetslisting">
      <div id="datasets-popup-result-list">
        <div class="row" tal:condition="batch">
          <div class="cell">
            <div metal:use-macro="context/batch_macros/macros/navigation" />
          </div>
        </div>
        <tal:repeat tal:repeat="item batch">
        <!-- non layered datasets -->
        <div class="datasets-list-entry"
             tal:attributes="data-uuid item/UID"
             tal:define="item_title_or_id item/pretty_title_or_id;
                         item_icon python:plone_view.getIcon(item);
                         item_creator item/Creator;
                         item_modified item/ModificationDate;
                         item_description item/Description;
                         md python:dataset_tools.metadata(item);
                         ">
          <div class="cell">
            <h4>
              <input type="radio" name="selected-layer"
                     tal:attributes="value string:select-${item/UID};
                                     type python: 'checkbox' if multiple=='multiple' else 'radio'" />
              <span tal:content="item_title_or_id">Item Title</span></h4>
            <ul>
              <li tal:condition="item_description"
                tal:content="item_description">Item description</li>
              <li tal:condition="md/resolution|nothing"><small><b>Resolution: <tal:r tal:replace="python: dataset_tools.resolution_vocab.getTerm(md['resolution']).title"></tal:r></b></small></li>
              <li tal:condition="md/emsc|nothing"><small><b>Emmission Scenario: <tal:r tal:replace="md/emsc"></tal:r></b></small></li>
              <li tal:condition="md/gcm|nothing"><small><b>Global Circulation Model: <tal:r tal:replace="md/gcm"></tal:r></b></small></li>
              <li tal:condition="python: 'layer' in filters">
                <small><b>Layers:</b>
                <ul tal:condition="python: 'layer' in filters">
                  <li tal:repeat="layer md/layers|nothing"
                      tal:define="layer_vocab python:dataset_tools.layer_vocab"
                      tal:content="python: layer_vocab.getTerm(layer).title">Layer Title
                  </li>
                </ul>
                </small>                
              </li>
              <li><strong>Creator:</strong> <span tal:condition="item_creator"
              tal:define="author python:pas_member.info(item_creator)"
              tal:content="author/name_or_id">Bob Dobalina</span></li>
              <li><strong>Modified:</strong> <span tal:content="python:toLocalizedTime(item_modified,long_format=1)">August 16, 2001 at 23:35:59</span></li>

            </ul>
          </div>
        </div>
        </tal:repeat>
        <div class="row" tal:condition="batch">
          <div class="cell">
            <div metal:use-macro="context/batch_macros/macros/navigation" />
          </div>
        </div>
        <div class="span12" style="margin-top:1em;"
             tal:condition="not:batch">
          <div class="alert alert-warning">
            <p><strong>No datasets match the required resolution and filters.</strong></p>
            <p>Try selecting a different resolution. You can also expand filters by selecting more in the same list.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</html>
