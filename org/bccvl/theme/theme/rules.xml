<rules
    xmlns="http://namespaces.plone.org/diazo"
    xmlns:css="http://namespaces.plone.org/diazo/css"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xi="http://www.w3.org/2001/XInclude">

    <theme href="html/homepage.html" /> <!--if="$is_anonymous"/>-->

    <!-- include rules specific to pages ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <xi:include href="rules/dataset-upload.xml" />
    <xi:include href="rules/dataset-list.xml" />
    <xi:include href="rules/dataset-import.xml" />
    <xi:include href="rules/experiment-list.xml" />
    <xi:include href="rules/experiment-results.xml" />
    <xi:include href="rules/new-experiment-sdm.xml" />
    <xi:include href="rules/new-experiment-projection.xml" />
    <xi:include href="rules/new-experiment-biodiverse.xml" />
    <xi:include href="rules/dashboard.xml" />
    <xi:include href="rules/knowledgebase.xml" />
    <xi:include href="rules/search.xml" />
    <xi:include href="rules/login.xml" />
    <xi:include href="rules/password-reset.xml" />
    <xi:include href="rules/edit-environmental-layers-metadata.xml" />
    <xi:include href="rules/sharing.xml" />
    <xi:include href="rules/feedback.xml" />

    <!-- view the unthemed page when using 127.0.0.1 as host header -->
    <notheme if="$host='127.0.0.1'" />

    <!-- don't theme ajax calls (Plone overlays) -->
    <notheme if="$ajax_load" />

    <notheme if="$norules"/>

    <!-- don't theme the page unless the user is logged in -->
    <!--<notheme css:if-content="#anon-personalbar" />-->

    <!-- don't theme if there is an error -->
    <notheme css:if-content="body.template-default_error_message" />

    <!-- don't theme special pages -->
    <notheme if-path="@@manage-job-queue/
                      @@overview-controlpanel/
                      @@usergroup-userprefs/
                      @@usergroup-groupprefs/
                      @@usergroup-controlpanel/
                      @@member-registration/
                      @@new-user/
                      @@usergroup-groupmembership/
                      @@usergroup-groupdetails/
                      @@manage-group-portlets/
                      @@manage-group-dashboard/
                      @@manage-dashboard/
                      @@caching-controlpanel/
                      prefs_install_products_form/
                      portal_registry" />

     <!--drop all non-plone content ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <drop css:theme=".non-plone" />

    <!-- inject manifest js config ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <after css:theme-children="#js-config">
        window.bccvl || (window.bccvl = {});
        window.bccvl.config || (window.bccvl.config = {});
        window.bccvl.config.data_mover = {
            baseUrl: '<xsl:value-of select="$portal_base_url" />/dv',
        };
        window.bccvl.config.visualiser = {
            baseUrl: '<xsl:value-of select="$visualiser_base_url" />',
        };

        local = false;
    </after>

    <!-- inject bccvl-lookups js config ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <replace css:content-children="#bccvl-lookups" css:theme-children="#bccvl-lookups" />

    <!-- push plone "portalMessage" content into the theme -->
    <replace css:theme-children=".bccvl-flashmessages">
        <xsl:for-each select="//dl[@class='portalMessage error']">
            <dl class="bccvl-flashmessage bccvl-flashmessage-error alert alert-block alert-error">
                <dt class="label label-important"><xsl:value-of select="./dt" /></dt>
                <xsl:copy-of select="./dd" />
                <xsl:copy-of select="following-sibling::div[@class='field error']"/>
            </dl>
        </xsl:for-each>
    </replace>

    <!-- hook up the user management menu ~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

    <!-- user name -->
    <replace css:theme-children=".bccvl-username" css:content-children="#user-name" />
    <!-- (other user handling is in the link section below) -->


    <!-- hook up the search bar ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

    <!-- yes, it really is 'searchGadget_form', plone replaces the id with javascript when an unthemed page is displayed -->
    <copy attributes="action method" css:theme="form#siteSearch" css:content="#searchGadget_form" />
    <copy attributes="name" css:theme="form#siteSearch input[name=siteSearchQuery]" css:content="#searchGadget" />

    <!-- Google Analytics -->
    <replace css:theme="script#google-analytics" css:content="script#google-analytics"/>


    <!-- update links ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!--
    This section replaces the href attribute of the theme links with
    the actual content links.

    We use css-selectors to look up the anchors (links) in the theme.
    Specifically, we're using css classes to classify where an anchor should
    link to link.

    We use XPATH to lookup the desired anchor in Plone's content page.

    We use Diazo's merge function to merge href attribute in the content with
    the href attribute in the template. For this reason, the href attribute
    in the template should always be undefined, i.e. no href attribute should
    be defined.
    -->

    <!-- portaltab (high level grouping) -->
    <merge attributes="href" css:theme="a.bccvllinks-home"              content="//li[@id='portaltab-index_html']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-dashboard"         content="//li[@id='personaltools-dashboard']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-news"              content="//li[@id='portaltab-news']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-events"            content="//li[@id='portaltab-events']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-users"             content="//li[@id='portaltab-Members']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-datasets"          content="//li[@id='portaltab-datasets']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-datasetsimport"    content="//li[@id='tab-datasetsimport']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-datasetsupload"    content="//li[@id='tab-datasetsupload']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-functions"         content="//li[@id='portaltab-functions']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-knowledgebase"     content="//li[@id='portaltab-knowledgebase']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-experiments"       content="//li[@id='portaltab-experiments']/a" />

    <!-- user management -->
    <merge attributes="href" css:theme="a.bccvllinks-adminaccess"       content="//li[@id='personaltools-plone_setup']/a" />
    <merge attributes="href" css:theme="a.bccvllinks-logoutuser"        content="//li[@id='personaltools-logout']/a" />

    <!-- anonymous user -->
    <rules if="$is_anonymous">
        <before
              content="/html/head/script"
              theme-children="/html/head" />
        <replace css:theme-children="#user-menu">
            <a id="personaltools-login" href="{$portal_base_url}/login" rel="#pb_1" class="link-overlay">
                <div class="btn">Log in</div>
            </a>
        </replace>

        <drop css:theme="a.bccvllinks-dashboard"/>
        <drop css:theme="a.bccvllinks-datasets"/>
        <drop css:theme="a.bccvllinks-experiments"/>
    </rules>

    <!-- contentview (content level grouping) -->
    <!-- experiment -->
    <merge attributes="href" css:theme="a.bccvllinks-experiment-view"   content="//li[@id='contentview-view']/a" />

    <!--    Link to create a new experiment:
            //a[@id="org-bccvl-content-sdmexperiment"]
            Note: This link is NOT available when viewing a specific experiment.
    -->
    <merge attributes="href" css:theme="a.bccvllinks-experiment-new"            content="//a[@id='org-bccvl-content-sdmexperiment']" />
    <merge attributes="href" css:theme="a.bccvllinks-experiment-proj-new"       content="//a[@id='org-bccvl-content-projectionexperiment']" />
    <merge attributes="href" css:theme="a.bccvllinks-experiment-biodiverse-new" content="//a[@id='org-bccvl-content-biodiverseexperiment']" />

    <!-- miscellaneous -->
    <!-- TODO: don't use // xpath selector. It is slow -->
    <!-- TODO: CSS3 selectors may be slower than XPath selectors -->
    <replace theme="//footer" content="//footer"/>

    <!-- if debug insert helper links in navbar -->
    <rules if="$is_debug">
    	<after css:theme="#siteSearch">
    		<button id="untheme" class="bccvl-devbutton pull-right"
				onclick="window.location.href = window.location.href.split(/[\?|#]/,1)[0] + '?diazo.off=1';"
			>no theme</button>
			<button id="debugtheme" class="bccvl-devbutton pull-right"
				onclick="window.location.href = window.location.href.split(/[\?|#]/,1)[0] + '?diazo.debug=1';"
			>debug theme</button>
			<button id="norules" class="bccvl-devbutton pull-right"
				onclick="window.location.href = window.location.href.split(/[\?|#]/,1)[0] + '?norules=1';"
			>no rules</button>
	</after>
    </rules>

</rules>
