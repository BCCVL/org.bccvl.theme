<rules
    xmlns="http://namespaces.plone.org/diazo"
    xmlns:css="http://namespaces.plone.org/diazo/css"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <!-- EXPERIMENT RESULTS ========================================= -->
    <rules css:if-content="#bccvl-experiment-view">
        <theme href="html/experiment-results.html" />

        <!-- get the experiment name for the breadcrumb trail from plone's breadcrumb trail -->
        <replace
            css:theme-children=".bccvl-breadcrumb .bccvllinks-experiment-view"
            css:content-children="#breadcrumbs-current"
        />

        <!-- update the job status -->

        <!--
            known possible statuses: Pending, Active, Performing Callbacks, Completed.
            template supported statuses: Active, Completed we'll use the template for
            all unknown statuses
        -->

        <!-- Use the template for all non-understood statuses -->
        <replace
            css:theme-children=".bccvl-status-template p.lead strong"
            content="//span[@id='form-widgets-IJobStatus-status']"
        />


        <!-- If not complete, then drop the complete status -->
        <rules if-content="//span[@id='form-widgets-IJobStatus-status']/text() != 'Completed'">
            <drop css:theme=".bccvl-status-complete" />
        </rules>

        <!-- If not running, then drop the running status -->
        <rules if-content="//span[@id='form-widgets-IJobStatus-status']/text() != 'Active'">
            <drop css:theme=".bccvl-status-running" />
        </rules>

        <!-- If there's no job status, drop everything -->
        <!--
        <rules if-content="not(//span[@id='form-widgets-IJobStatus-status']/string(.))">
            <drop css:theme=".bccvl-status-running" />
            <drop css:theme=".bccvl-status-complete" />
        </rules>

        <rules if-content="//span[@id='form-widgets-IJobStatus-status']/string(.)">
            <drop css:theme=".bccvl-status-error" />
        </rules>
        -->
        <!-- Always drop the not started status ?? -->
        <drop css:theme=".bccvl-status-notstarted" />

        <!--
            NOTE: This is temporary.
            TEMP: Get the experiment results from the results folder for this experiment.
            Only do this if the experiment is in the completed state.
        <before
            css:theme-children=".bccvl-experimentresults table tbody"
            css:content-children="#listing-table tbody"
            if-content="//span[@id='form-widgets-IJobStatus-status']/text() = 'Completed'"
            href="result/folder_contents"
        />
        -->
        <before css:theme-children=".bccvl-experimentresults table tbody">
            <xsl:for-each select="//*[@id='bccvl-experiment-results']//li//a">
                <tr>
                    <td colpan="2" class="bccvl-table-label">
                        <h1><xsl:copy-of select="text()" /></h1>
                        <p class="broken">(provenance &amp; description)</p>
                    </td>
                    <td class="bccvl-table-controls">
                        <xsl:element name="a">
                            <xsl:attribute name="class">bccvl-auto-viz</xsl:attribute>
                            <xsl:attribute name="title">preview this dataset</xsl:attribute>
                            <xsl:attribute name="data-viz-id"><xsl:value-of select="@href" />/++widget++form.widgets.file/@@download/<xsl:copy-of select="text()" /></xsl:attribute>
                            <i class="icon-eye-open"></i>
                        </xsl:element>
                    </td>
                </tr>
            </xsl:for-each>
        </before>


        <!-- place-holder ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

    </rules>
</rules>
