<rules
    xmlns="http://namespaces.plone.org/diazo"
    xmlns:css="http://namespaces.plone.org/diazo/css"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <!-- NEW SDM EXPERIMENT ========================================= -->
    <rules if-path="++add++org.bccvl.content.experiment/">
        <theme href="html/new-experiment-sdm.html" />

        <!-- hook in the new experiment form's attributes -->
        <copy attributes="name action enctype" css:theme="form#experimentSetup" css:content="#form" />

        <!-- hook in the submit (save) button -->
        <copy attributes="name value" css:theme="form#experimentSetup button[type=submit]" css:content="#form-buttons-save" />

        <!-- hook in title field -->
        <copy attributes="name value" css:theme="form#experimentSetup .bccvl-expname" css:content="#form-widgets-IDublinCore-title" />

        <!-- hook in description field -->
        <replace theme-children="//textarea[@name='expDescription']" content="//textarea[@id='form-widgets-IDublinCore-description']/text()" />
        <copy attributes="name value" css:theme="form#experimentSetup .bccvl-expdesc" css:content="#form-widgets-IDublinCore-description" />

        <!-- hook in the algorithm list -->
        <before css:theme-children="section.bccvl-experimentdetails table.bccvl-algorithmtable > tbody">
            <xsl:for-each select="//input[@name='form.widgets.functions:list']">
                <tr>
                    <td class="bccvl-table-choose">
                        <xsl:element name="input">
                            <xsl:attribute name="type">checkbox</xsl:attribute>
                            <xsl:attribute name="name">
                                <xsl:value-of select="@name" />
                            </xsl:attribute>
                            <xsl:if test="@checked">
                                <xsl:attribute name="checked">checked</xsl:attribute>
                            </xsl:if>
                            <xsl:attribute name="id">
                                <xsl:value-of select="@id" />
                            </xsl:attribute>
                            <xsl:attribute name="value">
                                <xsl:value-of select="@value" />
                            </xsl:attribute>
                        </xsl:element>
                    </td>
                    <td class="bccvl-table-label">
                        <xsl:element name="label">
                            <xsl:attribute name="for">
                                <xsl:value-of select="@id" />
                            </xsl:attribute>
                            <h1><xsl:copy-of select="string(../label/span/text())" /> <small class="broken">Algorithm Description</small></h1>
                        </xsl:element>
                    </td>
                    <td class="bccvl-table-controls">
                        <a><i class="icon-info-sign" title="more information"></i></a>
                    </td>
                </tr>
            </xsl:for-each>
        </before>

        <!-- loop through the algorithm list again, this time poking the config blocks into the config block accordion -->
        <after css:theme-children="#algoConfig">

            <xsl:for-each select="//input[@name='form.widgets.functions:list']">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <xsl:element name="a">
                            <xsl:attribute name="class">accordion-toggle collapsed</xsl:attribute>
                            <xsl:attribute name="data-toggle">collapse</xsl:attribute>
                            <xsl:attribute name="data-parent">#algoConfig</xsl:attribute>
                            <xsl:attribute name="href">#accordion_body_<xsl:value-of select="@id" /></xsl:attribute>
                            <xsl:value-of select="string(../label/span/text())" /> configuration parameters
                        </xsl:element>
                    </div>

                    <xsl:element name="div">
                        <xsl:attribute name="class">accordion-body collapse</xsl:attribute>
                        <xsl:attribute name="id">accordion_body_<xsl:value-of select="@id" /></xsl:attribute>

                        <div class="accordion-inner bccvl-algo-config">
                            <fieldset class="form-horizontal">
                                <xsl:value-of select="position()" />
                                <xsl:copy-of select="//div[@class='object-widget']" />
                            </fieldset>
                        </div>
                    </xsl:element>
                </div>
            </xsl:for-each>

        </after>

        <!-- hook in the environmental data list -->
        <!--
            We are converting a select to a checkbox input,
            so we need to give the radio button the select's name,
            not the option's name.
        -->
        <before css:theme-children="section.bccvl-experimentdetails table.bccvl-environmentaldatatable > tbody">
            <xsl:for-each select="//select[@id='form-widgets-environmental_dataset']/option">
                <xsl:if test="@value!='--NOVALUE--'">
                    <tr>
                        <td class="bccvl-table-choose">
                            <xsl:element name="input">
                                <xsl:attribute name="type">checkbox</xsl:attribute>
                                <xsl:attribute name="name">
                                    <xsl:value-of select="string(../@name)" />
                                </xsl:attribute>
                                <xsl:if test="@selected">
                                    <xsl:attribute name="checked">checked</xsl:attribute>
                                </xsl:if>
                                <xsl:attribute name="id">
                                    <xsl:value-of select="@id" />
                                </xsl:attribute>
                                <xsl:attribute name="value">
                                    <xsl:value-of select="@value" />
                                </xsl:attribute>
                            </xsl:element>
                        </td>
                        <td class="bccvl-table-label">
                            <xsl:element name="label">
                                <xsl:attribute name="for">
                                    <xsl:value-of select="@id" />
                                </xsl:attribute>
                                <h1><xsl:copy-of select="text()" /></h1><p class="broken">provenance description</p>
                            </xsl:element>
                        </td>
                        <td class="bccvl-table-controls">
                            <a><i class="broken icon-eye-open" title="preview this dataset"></i></a>
                            <!-- <a><i class="broken icon-cog" title="uh, dunno"></i></a> -->
                        </td>
                    </tr>
                </xsl:if>
            </xsl:for-each>
        </before>

        <!-- hook in the occurrences list -->

        <!--
            We are converting a select to a radio button input,
            so we need to give the radio button the select's name,
            not the option's name.

        -->
        <before css:theme-children="section.bccvl-experimentdetails table.bccvl-occurrencestable > tbody">
            <xsl:for-each select="//select[@id='form-widgets-species_occurrence_dataset']/option">
                <xsl:if test="@value!='--NOVALUE--'">
                    <tr>
                        <td class="bccvl-table-choose">
                            <xsl:element name="input">
                                <xsl:attribute name="type">radio</xsl:attribute>
                                <xsl:attribute name="name">
                                    <xsl:value-of select="string(../@name)" />
                                </xsl:attribute>
                                <xsl:if test="@selected">
                                    <xsl:attribute name="checked">checked</xsl:attribute>
                                </xsl:if>
                                <xsl:attribute name="id">
                                    <xsl:value-of select="@id" />
                                </xsl:attribute>
                                <xsl:attribute name="value">
                                    <xsl:value-of select="@value" />
                                </xsl:attribute>
                            </xsl:element>
                        </td>
                        <td class="bccvl-table-label">
                            <xsl:element name="label">
                                <xsl:attribute name="for">
                                    <xsl:value-of select="@id" />
                                </xsl:attribute>
                                <h1><xsl:copy-of select="text()" /></h1><p class="broken">provenance description</p>
                            </xsl:element>
                        </td>
                        <td class="bccvl-table-controls">
                            <xsl:element name="a">
                                <xsl:attribute name="class">fine bccvl-occurrence-viz</xsl:attribute>
                                <xsl:attribute name="title">preview this dataset</xsl:attribute>
                                <xsl:attribute name="data-viz-id"><xsl:value-of select="@value" /></xsl:attribute>
                                <i class="icon-eye-open"></i>
                            </xsl:element>
                            <!-- <a><i class="broken icon-cog" title="uh, dunno"></i></a> -->
                        </td>
                    </tr>
                </xsl:if>
            </xsl:for-each>
        </before>

        <!-- hook in the absences list -->
        <before css:theme-children="section.bccvl-experimentdetails table.bccvl-absencestable > tbody">
            <xsl:for-each select="//select[@id='form-widgets-species_absence_dataset']/option">
                <xsl:if test="@value!='--NOVALUE--'">
                    <tr>
                        <td class="bccvl-table-choose">
                            <xsl:element name="input">
                                <xsl:attribute name="type">radio</xsl:attribute>
                                <xsl:attribute name="name">
                                    <xsl:value-of select="string(../@name)" />
                                </xsl:attribute>
                                <xsl:if test="@selected">
                                    <xsl:attribute name="checked">checked</xsl:attribute>
                                </xsl:if>
                                <xsl:attribute name="id">
                                    <xsl:value-of select="@id" />
                                </xsl:attribute>
                                <xsl:attribute name="value">
                                    <xsl:value-of select="@value" />
                                </xsl:attribute>
                            </xsl:element>
                        </td>
                        <td class="bccvl-table-label">
                            <xsl:element name="label">
                                <xsl:attribute name="for">
                                    <xsl:value-of select="@id" />
                                </xsl:attribute>
                                <h1><xsl:copy-of select="text()" /></h1><p class="broken">provenance description</p>
                            </xsl:element>
                        </td>
                        <td class="bccvl-table-controls">
                            <xsl:element name="a">
                                <xsl:attribute name="class">fine bccvl-absence-viz</xsl:attribute>
                                <xsl:attribute name="title">preview this dataset</xsl:attribute>
                                <xsl:attribute name="data-viz-id"><xsl:value-of select="@value" /></xsl:attribute>
                                <i class="icon-eye-open"></i>
                            </xsl:element>
                            <!-- <a><i class="broken icon-cog" title="uh, dunno"></i></a> -->
                        </td>
                    </tr>
                </xsl:if>
            </xsl:for-each>
        </before>

        <!-- Add any error information into the page -->
        <!-- Attach data-error to any error'd field -->

    </rules>

</rules>
